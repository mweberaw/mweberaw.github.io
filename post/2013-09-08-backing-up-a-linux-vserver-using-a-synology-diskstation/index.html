<!doctype html><html lang=en-us>
<head>
<title>Backing up a linux vserver using a Synology Diskstation // Otherland</title>
<link rel="shortcut icon" href=/favicon.ico>
<meta charset=utf-8>
<meta name=generator content="Hugo 0.92.2">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=author content="John Doe">
<meta name=description content>
<link rel=stylesheet href=https://mweberaw.github.io/css/main.min.88e7083eff65effb7485b6e6f38d10afbec25093a6fac42d734ce9024d3defbd.css>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Backing up a linux vserver using a Synology Diskstation">
<meta name=twitter:description content="If you have your own linux vserver or root server, you most probably also have information on this server that you do not want to lose. Backing up the data of the server is the most crucial part in avoiding information loss by anything that can happen to your server. For those who have a Synology Diskstation, this task is not too complex.
First make sure rsync is installed on the server you have to backup.">
<meta property="og:title" content="Backing up a linux vserver using a Synology Diskstation">
<meta property="og:description" content="If you have your own linux vserver or root server, you most probably also have information on this server that you do not want to lose. Backing up the data of the server is the most crucial part in avoiding information loss by anything that can happen to your server. For those who have a Synology Diskstation, this task is not too complex.
First make sure rsync is installed on the server you have to backup.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://mweberaw.github.io/post/2013-09-08-backing-up-a-linux-vserver-using-a-synology-diskstation/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2013-09-08T00:00:00+00:00">
<meta property="article:modified_time" content="2013-09-08T00:00:00+00:00">
</head>
<body>
<header class=app-header>
<a href=https://mweberaw.github.io><img class=app-header-avatar src=/avatar.jpg alt="John Doe"></a>
<h1>Otherland</h1>
<nav class=app-header-menu>
<a class=app-header-menu-item href=/impressum/>Impressum</a>
</nav>
<p>Where dreams start living...</p>
<div class=app-header-social>
<a target=_blank href=https://twitter.com/mweberkl rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a>
</div>
</header>
<main class=app-container>
<article class=post>
<header class=post-header>
<h1 class=post-title>Backing up a linux vserver using a Synology Diskstation</h1>
<div class=post-meta>
<div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Sep 8, 2013
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
3 min read
</div>
</div>
</header>
<div class=post-content>
<p>If you have your own linux vserver or root server, you most probably also have information on this server that you do not want to lose. Backing up the data of the server is the most crucial part in avoiding information loss by anything that can happen to your server. For those who have a Synology Diskstation, this task is not too complex.</p>
<p>First make sure <em>rsync</em> is installed on the server you have to backup. This handy tool is designed to transfer huge amount of data over an encrypted link. The tool uses <em>ssh</em> to secure the transfer. The biggest advantage you gain is that rsync only transfers parts of your files that have been changed after the last run.</p>
<p>The next step is to configure <em>ssh</em> (which should be available on almost all linux servers out there) such that your diskstation can log into your server without password. This can be done using public key authentication. Log into your diskstation using <em>ssh</em> (you may have to enable ssh access to your box first under <code>Control Panel -> Terminal -> Enable SSH Service</code>). I logged in as user admin. Next you have to generate a new ssh public key using the following command:</p>
<pre tabindex=0><code>DiskStation&gt; ssh-keygen -t rsa
</code></pre><p>Do not add a password for the key since you would have to enter the password each time the diskstation connects to your server. Since we want to use the key to connect at a specific time at night when no user interaction is possible, adding a password would make this technique not work. The <strong>public</strong> part of this new ssh-key has to be transferred to your server and added to the <code>authorized_keys</code> file under the home directory of the user you want to log in.</p>
<pre tabindex=0><code>DiskStation&gt; scp /var/services/homes/admin/.ssh/id_rsa.pub backupuser@example.com:diskstation.pub
</code></pre><p>Log onto your server using ssh.</p>
<pre tabindex=0><code>Server&gt; cat diskstation.pub &gt;&gt; .ssh/authorized_keys
</code></pre><p>Now your admin user of your diskstation can log into your server without entering a password. The next step is to create a folder where to backup your vserver data. You can do this using the Shared Folder item in the control panel. I created a shared folder <em>backup</em> on volume 1 in this case.</p>
<p>The last part is to finally write the script that backups your servers data to your diskstation. You can use the following code as a starting point:</p>
<pre tabindex=0><code>#!/bin/sh
/usr/syno/bin/rsync -avz -e '/usr/syno/bin/ssh -i /var/services/homes/admin/.ssh/id_rsa' backupuser@example.com:/data /volume1/backup/vserver
</code></pre><p>Replace <em>backupuser</em> with the user of your vserver that has access to the data you want to backup. Also replace <em>example.com</em> with your domain. In the example above, I want to backup everything under <em>/data</em> on my server into the folder vserver in my backup shared folder. Do not forget to adapt the ssh private key you have generated in one of the first steps of the post. The path should be the same as for the ssh public key dropping the <em>.pub</em> suffix. Save the script under some file name and make it executable.</p>
<pre tabindex=0><code>DiskStation&gt; chmod 755 /path/to/your/script.sh
</code></pre><p>Now go to the control panel of your diskstation and into the Task Scheduler. Create a new task and choose <em>User-defined script</em>. Choose a name for the new task, for example “Backup VServer”. As user choose the user that should run the task, in my case <em>admin</em>. As user-defined script you can use something like the following snippet:</p>
<pre tabindex=0><code>/bin/sh /path/to/your/script.sh &gt; /volume1/backup_vserver.log 2&gt;&amp;1
</code></pre><p>This will run the script your have created earlier and write a log file of the last run to the file <code>/volume1/backup_vserver.log</code>. In the Schedule tab you can define, when the script will be executed. When done, try to run the script for the first time and check the log file for errors. If all looks fine, your diskstation will pull a backup of the data on your vserver in the specified interval.</p>
</div>
<div class=post-footer>
</div>
</article>
</main>
</body>
</html>